{% comment %} variant: "meta" = page__meta 인라인(버튼만, HTML 없음), "footer" = 글 아래 전체 섹션 {% endcomment %}
{% assign _idx = 0 %}
{% if include.variant == "footer" %}{% assign _idx = 1 %}{% endif %}

{% unless include.variant == "meta" %}
<style>
  .like-section { text-align: right; margin: 20px 0 0 0; }
  .like-btn {
    background-color: white; border: none; font-size: 14px;
    color: #586069; cursor: pointer;
    transition: all 0.3s ease; outline: none;
    display: inline-flex; align-items: center; justify-content: center;
    gap: 4px;
    font-weight: bold;
  }
  .heart-svg {
    width: 14px; height: 14px;
    fill: none; stroke: #ff4d4d; stroke-width: 2;
    stroke-linecap: round; stroke-linejoin: round;
  }
  .like-btn.liked .heart-svg { fill: #ff4d4d; stroke: #ff4d4d; }
  .heart-beat { animation: heartBeat 0.3s ease-in-out; }
  @keyframes heartBeat {
    0% { transform: scale(1); } 10% { transform: scale(0.8); }
    50% { transform: scale(1.2); } 70% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }
</style>

<div id="like-section-{{ _idx }}" class="like-section">
  <button id="like-btn-{{ _idx }}" class="like-btn" aria-label="Like button">
    <svg id="heart-svg-{{ _idx }}" class="heart-svg" viewBox="0 0 22 21">
      <path d="M11 21c-6.6-5.99-10-9.07-10-12.85 0-3.08 2.42-5.5 5.5-5.5 1.74 0 3.41.91 4.5 2.59 1.09-1.68 2.76-2.59 4.5-2.59 3.08 0 5.5 2.42 5.5 5.5 0 3.78-3.4 6.86-10 12.85z"></path>
    </svg>
    <span id="like-text-{{ _idx }}">Like</span>
    <span id="like-count-{{ _idx }}" class="like-count">0</span>
  </button>
</div>
{% endunless %}

<script type="module">
  import { db, analytics, ref, get, runTransaction, onValue } from "/assets/js/firebase-init.js";

  const postUrl = "{{ document.url }}";
  const postId = btoa(postUrl).replace(/\//g, "_").replace(/=/g, ""); 
  const storageKey = `like_${postId}`; // 로컬스토리지에 저장될 고유 키
  const likeRef = ref(db, `${postUrl}/like`);

  const likeBtn = document.getElementById('like-btn-{{ _idx }}');
  const likeCountSpan = document.getElementById('like-count-{{ _idx }}');
  const heartSvg = document.getElementById('heart-svg-{{ _idx }}');

  // Get initial like count and listen for changes
  onValue(likeRef, (snapshot) => {
    const data = snapshot.val();

    if (data === null) {
      likeCountSpan.innerText = '0';
    } else {
      likeCountSpan.innerText = data;
    }

    // Check if the user has liked this post (storageKey) by checking localStorage.
    if (localStorage.getItem(storageKey) === 'true') {
      likeBtn.classList.add('liked');
      if (heartSvg && heartSvg.classList && heartSvg.classList.contains('fa-heart')) {
        heartSvg.classList.remove('far'); heartSvg.classList.add('fas');
      }
    } else {
      likeBtn.classList.remove('liked');
      if (heartSvg && heartSvg.classList && heartSvg.classList.contains('fa-heart')) {
        heartSvg.classList.remove('fas'); heartSvg.classList.add('far');
      }
    }
  });

  // Click event
  likeBtn.onclick = () => {
    const isAlreadyLiked = localStorage.getItem(storageKey) === 'true';

    if (heartSvg) {
      heartSvg.classList.add('heart-beat');
      setTimeout(() => heartSvg.classList.remove('heart-beat'), 400);
    }

    runTransaction(likeRef, (data) => {
      if (!data) data = 0;

      if (isAlreadyLiked) {
        data = Math.max(0, data - 1);
        localStorage.removeItem(storageKey);
      } else {
        data = data + 1;
        localStorage.setItem(storageKey, 'true');
      }
      return data;
    });

    if (heartSvg && heartSvg.classList && heartSvg.classList.contains('fa-heart')) {
      if (isAlreadyLiked) {
        heartSvg.classList.remove('fas'); heartSvg.classList.add('far');
      } else {
        heartSvg.classList.remove('far'); heartSvg.classList.add('fas');
      }
    }
  };
</script>