<style>
  .like-section { text-align: right; margin: 20px 0 0 0; }
  .like-btn {
    background-color: white; border: none; font-size: 14px;
    color: #586069; cursor: pointer;
    transition: all 0.3s ease; outline: none;
    display: inline-flex; align-items: center; justify-content: center;
    gap: 4px;
    font-weight: bold;
  }
  /* 좋아요 누른 상태 스타일 */
  /* .like-btn.liked { background: #ff4d4d; color: white; } */

  /* SVG 아이콘 기본 스타일 */
  .heart-svg {
    width: 14px; /* 아이콘 크기 조절 */
    height: 14px;
    fill: none; /* 기본은 채우기 없음 */
    stroke: #ff4d4d; /* 테두리 색상 */
    stroke-width: 1;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  /* 좋아요 눌렀을 때 SVG 아이콘 스타일 */
  .like-btn.liked .heart-svg {
    fill: #ff4d4d; /* 꽉 찬 색상 */
    stroke: #ff4d4d; /* 테두리 색상도 채우기 색상과 동일하게 */
  }
  
  /* 이모지 애니메이션 */
  .heart-beat { animation: heartBeat 0.3s ease-in-out; }
  
  @keyframes heartBeat {
    0% { transform: scale(1); }
    10% { transform: scale(0.8); }
    50% { transform: scale(1.2); }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }
</style>

<div id="like-section-{{ include.index }}" class="like-section">
  <button id="like-btn-{{ include.index }}" class="like-btn" aria-label="Like button">
    <svg id="heart-svg-{{ include.index }}" class="heart-svg" viewBox="0 0 22 21">
      <path d="M11 21c-6.6-5.99-10-9.07-10-12.85 0-3.08 2.42-5.5 5.5-5.5 1.74 0 3.41.91 4.5 2.59 1.09-1.68 2.76-2.59 4.5-2.59 3.08 0 5.5 2.42 5.5 5.5 0 3.78-3.4 6.86-10 12.85z"></path>
    </svg>
    <span id="like-text-{{ include.index }}">Like</span>
    <span id="like-count-{{ include.index }}" class="like-count">0</span>
  </button>
</div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  import { getDatabase, ref, get, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
  
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAzTCUqQHpltS7GwxbFFwG-ZeXQn-t7TRI",
    authDomain: "my-tech-blog-138bf.firebaseapp.com",
    databaseURL: "https://my-tech-blog-138bf-default-rtdb.firebaseio.com",
    projectId: "my-tech-blog-138bf",
    storageBucket: "my-tech-blog-138bf.firebasestorage.app",
    messagingSenderId: "918377144391",
    appId: "1:918377144391:web:82b933cc0fe91390621162",
    measurementId: "G-FND0SQMRJW"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  const postUrl = "{{ page.url }}";
  const postId = btoa(postUrl).replace(/\//g, "_").replace(/=/g, ""); 
  const storageKey = `like_${postId}`; // 로컬스토리지에 저장될 고유 키
  const likeRef = ref(db, postUrl);

  const likeBtn = document.getElementById('like-btn-{{ include.index }}');
  const likeCountSpan = document.getElementById('like-count-{{ include.index }}');
  const heartSvg = document.getElementById('heart-svg-{{ include.index }}');

  // Style
  if (`{{ include.style }}` == 'header') {
    const likeSection = document.getElementById('like-section-{{ include.index }}');
    likeSection.style.textAlign = 'left';
    likeSection.style.margin = '0';
    likeBtn.style.margin = '0';
    likeBtn.style.padding = '0';

    // Remove text for header style
    const likeText = document.getElementById('like-text-{{ include.index }}');
    likeText.innerText = '';
  }

  // Get initial like count and listen for changes
  onValue(likeRef, (snapshot) => {
    const data = snapshot.val();

    console.log('{{ include.index }}', data);
    if (data === null) {
      likeCountSpan.innerText = '0';
    } else {
      likeCountSpan.innerText = data;
    }

    // Check if the user has liked this post (storageKey) by checking localStorage.
    if (localStorage.getItem(storageKey) === 'true') {
      likeBtn.classList.add('liked');
    } else {
      likeBtn.classList.remove('liked');
    }
  });

  // Click event
  likeBtn.onclick = () => {
    console.log('Like button {{ include.index }} clicked');
    const isAlreadyLiked = localStorage.getItem(storageKey) === 'true';

    heartSvg.classList.add('heart-beat');
    setTimeout(() => heartSvg.classList.remove('heart-beat'), 400);

    runTransaction(likeRef, (data) => {
      if (!data) data = 0;

      if (isAlreadyLiked) {
        data = Math.max(0, data - 1);
        localStorage.removeItem(storageKey);
      } else {
        data = data + 1;
        localStorage.setItem(storageKey, 'true');
      }
      return data;
    });
  };
</script>